#!/bin/bash
DOWNLOAD_URL="https://github.com/alexkkork/Multi-Launch/raw/refs/heads/main/Multi-launch"
TEMP_DOWNLOAD_PATH="/tmp/MultiLaunch_download_$(date +%s)"
TARGET_APP_NAME="MultiLaunch.app"
TARGET_APPLICATIONS_DIR="/Applications"
USER_APPLICATIONS_DIR="$HOME/Applications"
FINAL_APP_PATH="${TARGET_APPLICATIONS_DIR}/${TARGET_APP_NAME}"
USER_APP_PATH="${USER_APPLICATIONS_DIR}/${TARGET_APP_NAME}"
echo "üöÄ Initiating MultiLaunch installation (with cleanup and launch)..."
echo "Searching for and removing previous MultiLaunch installations..."
if [ -d "$FINAL_APP_PATH" ]; then
    echo "  Found existing MultiLaunch in /Applications. Removing..."
    sudo rm -rf "$FINAL_APP_PATH" || { echo "‚ùå Error: Failed to remove existing app in /Applications. Sudo permissions required."; exit 1; }
fi
if [ -d "$USER_APP_PATH" ]; then
    echo "  Found existing MultiLaunch in ~/Applications. Removing..."
    rm -rf "$USER_APP_PATH" || { echo "‚ùå Error: Failed to remove existing app in ~/Applications."; exit 1; }
fi
rm -f /tmp/MultiLaunch_download_*
rm -rf /tmp/MultiLaunch_extract_*
echo "Downloading MultiLaunch application..."
if ! curl -L -o "$TEMP_DOWNLOAD_PATH" "$DOWNLOAD_URL"; then
    echo "‚ùå Error: Failed to download MultiLaunch. Exiting."
    exit 1
fi
echo "Configuring permissions and preparing MultiLaunch for use..."
if ! xattr -rd com.apple.quarantine "$TEMP_DOWNLOAD_PATH" &>/dev/null; then
    echo "‚ö†Ô∏è Warning: Could not remove quarantine attributes. You might need to manually approve the app."
fi
if ! chmod +x "$TEMP_DOWNLOAD_PATH" &>/dev/null; then
    echo "‚ö†Ô∏è Warning: Could not set executable permissions for MultiLaunch."
fi
echo "Moving MultiLaunch to the /Applications folder..."
sudo mkdir -p "$TARGET_APPLICATIONS_DIR" &>/dev/null
if ! sudo mv "$TEMP_DOWNLOAD_PATH" "$FINAL_APP_PATH"; then
    echo "‚ùå Error: Failed to move MultiLaunch to /Applications. This usually requires your password."
    echo "Please ensure you have administrator privileges and try again."
    rm -f "$TEMP_DOWNLOAD_PATH"
    exit 1
fi
echo "‚úÖ MultiLaunch installation complete!"
echo "You can now find MultiLaunch in your Applications folder."
echo "Launching MultiLaunch..."
if open "$FINAL_APP_PATH"; then
    echo "MultiLaunch launched successfully."
else
    echo "‚ùå Error: Failed to launch MultiLaunch. You may need to launch it manually."
fi
